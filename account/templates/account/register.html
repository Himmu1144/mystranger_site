{% extends 'base.html' %}
{% load static %}

{% block body %}


<style type="text/css">

  .card-signin {
	  width: 100%;
	  max-width: 400px;
	  padding: 15px;
	  margin: auto;
  }
  
  .form-signin input[type="email"] {
    margin-bottom: 10px;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0;
  }
  .form-signin input[type="text"] {
    margin-bottom: 10px;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0;
  }
  .form-signin input[type="password"] {
    margin-bottom: -1px;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }

  .rectangle{
    margin-top: 10vh;
    display: flex;
    justify-content: center;
    /* background-color: red; */
  }

  .box1{
    /* border: 2px solid black; */
    width: 30vw;
  }
  .box2{
    /* border: 2px solid purple; */
    width: 25vw;
  }


</style>

<div class="container-fluid">
  <div class='rectangle'>
  <div class='box1'>
	<div class="row justify-content-center">
		<div class="card card-signin" style="height: 321px; width: 371px;">
		  <div class="card-body">
		    <form class="form-signin" method="post">{% csrf_token %}
				<div class="d-flex flex-column pb-3">
				</div>
				<input type="email" name="email" id="inputEmail" class="form-control" placeholder="Email address" required autofocus>

				<input type="password" name="password1" id="inputPassword1" class="form-control" placeholder="Password" required>

				<input type="password" name="password2" id="inputPassword2" class="form-control" placeholder="Confirm password" required>

				{% for field in registration_form %}
				<p>
				{% for error in field.errors %}
				<p style="color: red">{{ error }}</p>
				{% endfor %}
				</p>
				{% endfor %}
				{% if registration_form.non_field_errors %}
				<div style="color: red">
					<p>{{registration_form.non_field_errors}}</p>
				</div>

				{% endif %}

				<button class="btn btn-lg btn-primary btn-block" type="submit">Register</button>

				</form>
		  </div>
		</div>
		
	</div>
</div>
<div class='box2'>
  <h6 id="uniName"></h6>
  <div id="map" style="height: 292px; width: 350px;"></div>
</div>
</div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<script>

  showMap(77.2219388,28.6517178,2)

	// Here we are handling the socket connection and also what happens when socket disconnects.
    // -----------------------------------------------------------------------------------------

    console.log("Setting up the WebSocket - ")

    // Correctly decide between ws:// and wss://
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var ws_path = ws_scheme + '://' + window.location.host + "/register/"; // development

    // console.log("Connecting to " + ws_path);
    chatSocket = new WebSocket(ws_path);

    // Handle incoming messages
    chatSocket.onmessage = function (message) {

        // Decode the JSON
        console.log("Got websocket message.");
        var data = JSON.parse(message.data);
        console.log(data)

		if(data.connected){
			console.log(data.connected)
		}

		if(data.universityName != null){
			console.log('hurrah ' , data.universityName)
      document.getElementById('uniName').innerHTML = 'University Name : ' + data.universityName
      showMap(data.lon,data.lat,14)
		}
	}

	// basic event listeners for our websocket
    // ------------------------------------------------------------------------

    chatSocket.addEventListener("open", function (e) {
        console.log("ChatSocket OPEN")

    })


    chatSocket.onclose = function (e) {
        console.log('Chat socket closed.');

    };

    chatSocket.onOpen = function (e) {
        console.log("ChatSocket onOpen", e)
    }

    chatSocket.onerror = function (e) {
        console.log('ChatSocket error', e)
    }

    if (chatSocket.readyState == WebSocket.OPEN) {
        console.log("ChatSocket OPENN")

    } else if (chatSocket.readyState == WebSocket.CONNECTING) {
        console.log("ChatSocket connecting..")
    }

    const email = document.getElementById('inputEmail');

    // Function to be executed when the first field has complete input
    function onInputChange() {
		console.log('calling email input')
		const emailAddress = email.value;
		if (emailAddress.endsWith('.edu.in')) {
			console.log(emailAddress);
			chatSocket.send(JSON.stringify({
				"command": "email",
				"email_address": emailAddress,
			}));
		  }
    }

    $('#inputEmail').on('input', function() {
		onInputChange()
	});

  function showMap(lon,lat,zoom){
    mapboxgl.accessToken = 'pk.eyJ1IjoicHVzaHBlbmRyYS0iLCJhIjoiY2t5Y2szbTFmMHExeDJ2cW9qMHE4b2o1biJ9.OKY1IsUcQDRE1oYJbpOdOg';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [lon, lat], 
            zoom: zoom // Default zoom level
        });

        // Create a default Marker and add it to the map.
        const marker1 = new mapboxgl.Marker()
            .setLngLat([lon, lat])
            .addTo(map);
  }


  </script>

{% endblock body %}